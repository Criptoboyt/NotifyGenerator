<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Notificações de Vendas</title>
    <!-- Tailwind CSS CDN para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Links para o Manifest do PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#22303f"> 
    
    <!-- **CÓDIGO DE INTEGRAÇÃO DO ONESIGNAL** -->
    <!-- Este script carrega o SDK principal do OneSignal AGORA LOCALMENTE -->
    <!-- MUDANÇA CRUCIAL: O "src" AGORA APONTA PARA O ARQUIVO LOCAL! -->
    <script src="OneSignalSDK.page.js" defer></script> 
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        // SÓCIO: COLOQUE SEU ONESIGNAL APP ID AQUI!
        // Você encontra ele no painel do OneSignal, em "Settings" > "Keys & IDs"
        await OneSignal.init({
          appId: "35838c3a-dc5d-4920-8b1b-117eedd90dba", // SUBSTITUA AQUI COM O SEU APP ID REAL DO ONESIGNAL!
          // Isso configura o Service Worker do OneSignal (OneSignalSDKWorker.js)
          // Ele DEVE ESTAR na raiz do seu site (mesma pasta do index.html)
          serviceWorkerPath: "OneSignalSDKWorker.js", 
        });

        // Opcional: Para pedir permissão automaticamente ou em um momento específico
        // OneSignal.Notifications.requestPermission(); 
        
        // Exemplo: Disparar um evento de teste de permissão após 5 segundos
        // setTimeout(() => {
        //   if (OneSignal.Notifications.permission !== 'granted') {
        //     OneSignal.Notifications.requestPermission();
        //   }
        // }, 5000); // Pede permissão após 5 segundos se ainda não foi concedida

        // Adicionar listener para quando o usuário se inscreve
        OneSignal.Notifications.addEventListener('subscriptionchange', function(isSubscribed) {
          console.log("Status de inscrição do OneSignal:", isSubscribed);
          if (isSubscribed) {
            console.log("Usuário inscrito para notificações push!");
          } else {
            console.log("Usuário não inscrito para notificações push.");
          }
        });

        // Opcional: Obter o ID do usuário OneSignal para envios direcionados (avançado)
        // const userId = await OneSignal.User.PushSubscription.getEphemeralId();
        // console.log("OneSignal User ID:", userId);
      });
    </script>
    <!-- **FIM DO CÓDIGO DO ONESIGNAL** -->
    
    <style>
        /* Estilos personalizados para o corpo e a fonte */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030e1b;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Contêiner principal do aplicativo */
        .app-container {
            background-color: #22303f;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        /* Estilo para inputs e selects */
        .form-input {
            width: 100%;
            padding: 12px 16px;
            margin-top: 8px;
            border: 1px solid #4a5568;
            border-radius: 12px;
            font-size: 1rem;
            color: #e2e8f0;
            background-color: #2d3748;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        /* Estilo para labels */
        label {
            color: #ffffff;
            font-size: 1.125rem;
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }
        /* Estilo para títulos */
        h1 {
            color: #ffffff;
            margin-bottom: 0px;
        }
        /* Estilo para o subtítulo */
        .subtitle {
            color: rgba(255, 255, 255, 0.35);
            font-size: 0.875rem;
            text-align: center;
            margin-top: 0px;
            margin-bottom: 24px;
            display: block;
        }

        /* Estilo para os botões */
        .btn {
            background-color: #2563eb;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            width: 100%;
            display: block;
            margin-top: 16px;
        }
        .btn:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.4);
        }

        .btn-stop {
            background-color: #ef4444;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .btn-stop:hover {
            background-color: #dc2626;
        }
        /* O botão de ativação de notificações do sistema não é mais necessário aqui,
           pois o OneSignal já gerencia a permissão automaticamente (se configurado) */
        .btn-system-notifications {
            display: none; /* Oculta o botão antigo de ativar notificações do sistema */
        }

        /* A notificação simulada dentro do app não é mais usada */
        .simulated-notification {
            display: none; 
        }
    </style>
</head>
<body class="antialiased">
    <div class="app-container">
        <h1 class="text-3xl font-bold text-center mb-0">
            Notify Generator
        </h1>
        <p class="subtitle">Created by: @CriptoBoyt</p>

        <!-- O botão de ativação de notificações do sistema (verde) foi removido,
             pois o OneSignal gerencia isso de forma mais integrada -->
        
        <div class="mb-6">
            <label for="platformSelect">
                Selecione a Plataforma:
            </label>
            <select id="platformSelect" class="form-input">
                <option value="kiwify">Kiwify</option>
                <option value="cakto">Cakto</option>
                <option value="kirvano">Kirvano</option>
                <option value="lastlink">Lastlink</option>
            </select>
        </div>

        <div class="mb-6">
            <label for="commissionInput">
                Valor da Comissão (R$):
            </label>
            <input type="number" id="commissionInput" class="form-input" placeholder="Ex: 29.90" step="0.01">
        </div>

        <div class="mb-6">
            <label for="customTextInput">
                Texto Personalizado (Opcional - Ex: Nome do Produto):
            </label>
            <input type="text" id="customTextInput" class="form-input" placeholder="Ex: Produto X">
        </div>

        <div class="mb-6">
            <label for="quantityInput">
                Quantidade de Notificações:
            </label>
            <input type="number" id="quantityInput" class="form-input" value="1" min="1">
        </div>

        <div class="mb-8">
            <label for="intervalInput">
                Intervalo entre Notificações (segundos):
            </label>
            <input type="number" id="intervalInput" class="form-input" value="3" min="0.5" step="0.5">
        </div>

        <button id="generateBtn" class="btn">
            Gerar Notificação(ões) via OneSignal
        </button>
        <button id="stopBtn" class="btn btn-stop" style="display: none;">
            Parar Geração
        </button>

        <!-- A div de notificação simulada interna não é mais necessária para as notificações de sistema -->
        <div id="notificationDisplay" style="display: none;"></div>
    </div>

    <script>
        // Mapeamento das plataformas com suas logos.
        const platformData = {
            'kiwify': {
                name: 'Kiwify',
                logo: 'https://i.ibb.co/8nqXygT5/LOGO-KIWIFY-PNG-OFC.png'
            },
            'cakto': {
                name: 'Cakto',
                logo: 'https://i.ibb.co/11DqF1w/LOGO-CAKTO-PNG-OFC.png'
            },
            'kirvano': {
                name: 'Kirvano',
                logo: 'https://i.ibb.co/6Rm5tvjW/LOGO-KIRVANO-PNG-OFC.png'
            },
            'lastlink': {
                name: 'Lastlink',
                logo: 'https://i.ibb.co/Z1ksXk08/LOGO-LASTLINK-PNG-OFC.png'
            }
        };

        // Obtenção dos elementos HTML
        const platformSelect = document.getElementById('platformSelect');
        const commissionInput = document.getElementById('commissionInput');
        const customTextInput = document.getElementById('customTextInput');
        const quantityInput = document.getElementById('quantityInput');
        const intervalInput = document.getElementById('intervalInput');
        const generateBtn = document.getElementById('generateBtn');
        const stopBtn = document.getElementById('stopBtn');
        // O botão 'activateSystemNotificationsBtn' e sua lógica foram removidos
        // pois o OneSignal lida com a permissão de notificação automaticamente.

        let notificationSequenceInterval;
        let currentNotificationCount = 0;

        // --- Lógica de Geração e Envio de Notificações via OneSignal ---

        // Função para enviar uma notificação push via OneSignal
        async function sendPushNotificationToOneSignal(platform, commission, customText) {
            // Verifica se o OneSignal está pronto e se o usuário está inscrito
            if (typeof OneSignal === 'undefined' || !OneSignal.Notifications || !(await OneSignal.Notifications.isPushEnabled())) {
                alert('As notificações do sistema não estão ativas. Por favor, permita as notificações no pop-up do navegador para receber.');
                console.warn('OneSignal não está pronto ou usuário não inscrito. Notificação do sistema não enviada.');
                // Tenta pedir permissão se não estiver ativo
                await OneSignal.Notifications.requestPermission();
                return;
            }

            // Formatação do valor da comissão para BRL
            const formattedCommission = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(commission);

            // Monta a mensagem e dados para enviar ao OneSignal
            let title = platform.name;
            let body = `Venda aprovada: Sua comissão ${formattedCommission}`;
            if (customText) {
                body = `Venda aprovada: ${customText} - ${formattedCommission}`;
            }

            // O OneSignal enviará a notificação para VOCÊ, o usuário que está acessando o site.
            // Para enviar para outros usuários ou segmentos, você precisaria de mais lógica (API REST do OneSignal).
            try {
                // Notificação para o usuário atual que está navegando no site
                await OneSignal.Notifications.triggerLocalNotification({
                    title: title,
                    body: body,
                    icon: platform.logo, // Ícone da plataforma na notificação do sistema
                    data: {
                        url: window.location.origin // O que acontece ao clicar na notificação
                    }
                });
                console.log('Notificação local do OneSignal disparada com sucesso!');

                // NOTA: Para enviar notificações para usuários offline ou segmentados,
                // você precisaria da REST API do OneSignal, que exige uma chave de API REST.
                // Isso normalmente é feito de um BACKEND SEPARADO.
                // Para o seu caso de "provas sociais" e para você mesmo receber, a notificação local
                // (disparada pelo OneSignal SDK no navegador) funciona como uma push notification real.

            } catch (error) {
                console.error('Erro ao enviar notificação OneSignal:', error);
                alert(`Erro ao enviar notificação: ${error.message}. Verifique o console.`);
            }
        }

        // Função para iniciar a sequência de notificações
        async function startNotificationSequence() {
            // Verifica se o OneSignal está pronto antes de tentar gerar notificações
            if (typeof OneSignal === 'undefined' || !OneSignal.Notifications) {
                alert('OneSignal ainda não foi inicializado. Por favor, aguarde alguns segundos e tente novamente. Certifique-se de que OneSignalSDK.page.js e OneSignalSDKWorker.js estão na raiz do seu site.');
                return;
            }

            // Esconde o botão Gerar e mostra o botão Parar
            generateBtn.style.display = 'none';
            stopBtn.style.display = 'block';

            // Para qualquer sequência existente antes de iniciar uma nova
            stopNotificationSequence();

            const selectedPlatformId = platformSelect.value;
            const platform = platformData[selectedPlatformId];
            
            let commissionValue = parseFloat(commissionInput.value);
            if (isNaN(commissionValue) || commissionInput.value.trim() === '') {
                commissionValue = 0;
            }

            const customText = customTextInput.value.trim();
            const quantity = parseInt(quantityInput.value, 10);
            const interval = parseFloat(intervalInput.value) * 1000;

            if (isNaN(quantity) || quantity < 1) {
                alert('Por favor, insira uma quantidade válida de notificações (mínimo 1).');
                return;
            }
            if (isNaN(interval) || interval < 500) {
                alert('Por favor, insira um intervalo válido (mínimo 0.5 segundos).');
                return;
            }
            
            // Verifica se o usuário permitiu as notificações push antes de iniciar a sequência
            if (!(await OneSignal.Notifications.isPushEnabled())) {
                alert('Por favor, ative as notificações do sistema (permita o pop-up de notificação do navegador) antes de gerar a sequência.');
                // O OneSignal geralmente exibe o prompt de permissão automaticamente,
                // mas você pode forçar aqui se quiser: OneSignal.Notifications.requestPermission();
                stopNotificationSequence();
                return;
            }


            currentNotificationCount = 0;

            // Inicia o intervalo para disparar as notificações
            notificationSequenceInterval = setInterval(() => {
                if (currentNotificationCount < quantity) {
                    sendPushNotificationToOneSignal(platform, commissionValue, customText);
                    currentNotificationCount++;
                } else {
                    stopNotificationSequence();
                }
            }, interval);
        }

        // Função para parar a sequência de notificações
        function stopNotificationSequence() {
            if (notificationSequenceInterval) {
                clearInterval(notificationSequenceInterval);
            }
            // Mostra o botão Gerar e esconde o botão Parar
            generateBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            currentNotificationCount = 0;
        }

        // Event Listeners
        generateBtn.addEventListener('click', startNotificationSequence);
        stopBtn.addEventListener('click', stopNotificationSequence);

        // Previne o comportamento padrão do Enter em campos de input
        const inputElements = [commissionInput, customTextInput, quantityInput, intervalInput];
        inputElements.forEach(input => {
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    startNotificationSequence();
                }
            });
        });
    </script>
</body>
</html>
