<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Notificações de Vendas</title>
    <!-- Tailwind CSS CDN para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- NOVOS: Links para o Manifest e Service Worker (essenciais para PWA) -->
    <link rel="manifest" href="manifest.json">
    <!-- Adicionando uma meta tag para a cor da barra de status em navegadores -->
    <meta name="theme-color" content="#22303f"> 
    
    <style>
        /* Estilos personalizados para o corpo e a fonte */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030e1b;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Contêiner principal do aplicativo */
        .app-container {
            background-color: #22303f;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        /* Estilo para inputs e selects */
        .form-input {
            width: 100%;
            padding: 12px 16px;
            margin-top: 8px;
            border: 1px solid #4a5568;
            border-radius: 12px;
            font-size: 1rem;
            color: #e2e8f0;
            background-color: #2d3748;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        /* Estilo para labels */
        label {
            color: #ffffff;
            font-size: 1.125rem;
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }
        /* Estilo para títulos */
        h1 {
            color: #ffffff;
            margin-bottom: 0px;
        }
        /* Estilo para o subtítulo */
        .subtitle {
            color: rgba(255, 255, 255, 0.35);
            font-size: 0.875rem;
            text-align: center;
            margin-top: 0px;
            margin-bottom: 24px;
            display: block;
        }

        /* Estilo para os botões */
        .btn {
            background-color: #2563eb;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            width: 100%;
            display: block;
            margin-top: 16px;
        }
        .btn:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.4);
        }

        .btn-stop {
            background-color: #ef4444;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .btn-stop:hover {
            background-color: #dc2626;
        }
        /* Estilo para botão de ativação de notificações do sistema */
        .btn-system-notifications {
            background-color: #10b981; /* Verde */
            margin-bottom: 24px; /* Espaço extra antes do formulário */
        }
        .btn-system-notifications:hover {
            background-color: #059669;
        }

        /* A notificação simulada dentro do app não será mais a principal */
        /* Mantida para fins de fallback ou visualização interna, mas não será usada para o push do sistema */
        .simulated-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s;
            z-index: 1000;
            max-width: 90%;
            box-sizing: border-box;
        }
        .simulated-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        .simulated-notification.hide {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(-100px);
        }
        .notification-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-right: 24px;
            object-fit: contain;
        }
        .notification-text {
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.4;
            font-weight: 500;
        }

        /* Ajustes para telas menores */
        @media (max-width: 640px) {
            .app-container {
                padding: 24px;
                border-radius: 16px;
            }
            .form-input {
                padding: 10px 14px;
                font-size: 0.95rem;
            }
            .btn {
                padding: 12px 20px;
                font-size: 0.95rem;
            }
            .simulated-notification {
                padding: 14px;
                top: 15px;
                border-radius: 14px;
            }
            .notification-icon {
                width: 64px;
                height: 64px;
                margin-right: 20px;
            }
            .notification-text {
                font-size: 0.9rem;
            }
            label {
                font-size: 1rem;
                margin-bottom: 6px;
            }
            .subtitle {
                font-size: 0.8rem;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="app-container">
        <h1 class="text-3xl font-bold text-center mb-0">
            Notify Generator
        </h1>
        <p class="subtitle">Created by: @CriptoBoyt</p>

        <button id="activateSystemNotificationsBtn" class="btn btn-system-notifications">
            Ativar Notificações do Sistema
        </button>

        <div class="mb-6">
            <label for="platformSelect">
                Selecione a Plataforma:
            </label>
            <select id="platformSelect" class="form-input">
                <option value="kiwify">Kiwify</option>
                <option value="cakto">Cakto</option>
                <option value="kirvano">Kirvano</option>
                <option value="lastlink">Lastlink</option>
            </select>
        </div>

        <div class="mb-6">
            <label for="commissionInput">
                Valor da Comissão (R$):
            </label>
            <input type="number" id="commissionInput" class="form-input" placeholder="Ex: 29.90" step="0.01">
        </div>

        <div class="mb-6">
            <label for="customTextInput">
                Texto Personalizado (Opcional - Ex: Nome do Produto):
            </label>
            <input type="text" id="customTextInput" class="form-input" placeholder="Ex: Produto X">
        </div>

        <div class="mb-6">
            <label for="quantityInput">
                Quantidade de Notificações:
            </label>
            <input type="number" id="quantityInput" class="form-input" value="1" min="1">
        </div>

        <div class="mb-8">
            <label for="intervalInput">
                Intervalo entre Notificações (segundos):
            </label>
            <input type="number" id="intervalInput" class="form-input" value="3" min="0.5" step="0.5">
        </div>

        <button id="generateBtn" class="btn">
            Gerar Notificação(ões) no Sistema
        </button>
        <button id="stopBtn" class="btn btn-stop" style="display: none;">
            Parar Geração
        </button>

        <!-- A notificação simulada dentro do app não será mais usada para push do sistema -->
        <div id="notificationDisplay" class="simulated-notification" style="display: none;">
            <img id="notificationIcon" src="" alt="Ícone da Plataforma" class="notification-icon">
            <div>
                <p id="notificationPlatformName" class="text-gray-900 font-semibold text-sm mb-1"></p>
                <p id="notificationMessage" class="notification-text"></p>
            </div>
        </div>
    </div>

    <script>
        // Mapeamento das plataformas com suas logos.
        // SÓCIO, É MUITO IMPORTANTE: SUBSTITUA OS URLs ABAIXO PELOS LINKS DIRETOS DAS SUAS LOGOS!
        const platformData = {
            'kiwify': {
                name: 'Kiwify',
                logo: 'https://i.ibb.co/8nqXygT5/LOGO-KIWIFY-PNG-OFC.png'
            },
            'cakto': {
                name: 'Cakto',
                logo: 'https://i.ibb.co/11DqF1w/LOGO-CAKTO-PNG-OFC.png'
            },
            'kirvano': {
                name: 'Kirvano',
                logo: 'https://i.ibb.co/6Rm5tvjW/LOGO-KIRVANO-PNG-OFC.png'
            },
            'lastlink': {
                name: 'Lastlink',
                logo: 'https://i.ibb.co/Z1ksXk08/LOGO-LASTLINK-PNG-OFC.png'
            }
        };

        // Obtenção dos elementos HTML
        const platformSelect = document.getElementById('platformSelect');
        const commissionInput = document.getElementById('commissionInput');
        const customTextInput = document.getElementById('customTextInput');
        const quantityInput = document.getElementById('quantityInput');
        const intervalInput = document.getElementById('intervalInput');
        const generateBtn = document.getElementById('generateBtn');
        const stopBtn = document.getElementById('stopBtn');
        const activateSystemNotificationsBtn = document.getElementById('activateSystemNotificationsBtn'); // Novo botão

        let notificationSequenceInterval;
        let currentNotificationCount = 0;
        let pushSubscription = null; // Armazenará a inscrição do push notification

        // Endpoint de Backend para ENVIAR a notificação.
        // SÓCIO: VOCÊ PRECISA IMPLEMENTAR ESTE BACKEND!
        // Este URL deve apontar para o seu servidor que vai receber a solicitação
        // e enviar a notificação push via FCM/APNs.
        const BACKEND_PUSH_ENDPOINT = 'https://SEU_ENDPOINT_DE_BACKEND_AQUI/send-push'; 
        // Exemplo: se usar Netlify Functions, pode ser 'https://seu-site.netlify.app/.netlify/functions/send-push'

        // --- Lógica de Push Notifications do Sistema ---

        // Função para pedir permissão e registrar Service Worker para Push
        async function requestNotificationPermissionAndSubscribe() {
            if (!('serviceWorker' in navigator)) {
                console.warn('Service Worker não é suportado neste navegador.');
                alert('Seu navegador não suporta Service Workers, o que é necessário para notificações do sistema.');
                return;
            }
            if (!('PushManager' in window)) {
                console.warn('Push API não é suportada neste navegador.');
                alert('Seu navegador não suporta a Push API para notificações do sistema.');
                return;
            }

            try {
                // 1. Pedir permissão ao usuário
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    console.error('Permissão para notificações não concedida.');
                    alert('Permissão para notificações não concedida. Não será possível enviar notificações do sistema.');
                    return;
                }
                console.log('Permissão para notificações concedida!');

                // 2. Obter o registro do Service Worker
                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    console.error('Nenhum Service Worker registrado.');
                    alert('Nenhum Service Worker registrado. Por favor, recarregue a página.');
                    return;
                }

                // 3. Obter ou criar uma inscrição (subscription) para push notifications
                pushSubscription = await registration.pushManager.getSubscription();
                if (pushSubscription === null) {
                    // Se não há inscrição, crie uma nova
                    // O VAPID public key é crucial para autenticar seu backend com o serviço de push.
                    // SÓCIO: SUBSTITUA PELA SUA CHAVE PÚBLICA VAPID AQUI!
                    // Esta chave é gerada pelo seu backend que usa o FCM/Web-Push.
                    // A CHAVE DEVE ESTAR ENTRE ASPAS SIMPLES!
                    const VAPID_PUBLIC_KEY = 'BOJ7ytg758AWbOBiIqxeUYpOJFQ024uUkV8r4wuV0Vr_o-majtDVxwxxRmf3DzU7OCnKfR4NLaOzU3q_PL_kqqI'; 
                    
                    if (VAPID_PUBLIC_KEY === 'SEU_VAPID_PUBLIC_KEY_AQUI' || !VAPID_PUBLIC_KEY) {
                        alert('Por favor, configure sua chave VAPID pública no código JavaScript para ativar notificações push. Ela deve estar entre aspas simples.');
                        console.error('Chave VAPID pública ausente ou incorreta. Não é possível se inscrever para notificações push.');
                        return;
                    }

                    pushSubscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true, // Sempre visível para o usuário
                        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });
                    console.log('Inscrição Push criada:', pushSubscription);
                    alert('Notificações do sistema ativadas com sucesso! Agora você pode gerar notificações no sistema.');
                } else {
                    console.log('Inscrição Push existente:', pushSubscription);
                    alert('Notificações do sistema já estão ativas!');
                }
                
                // Opcional: Enviar a inscrição para o seu backend para que ele saiba para onde enviar
                // console.log('Enviando inscrição para o backend...');
                // await fetch(`${BACKEND_PUSH_ENDPOINT}/subscribe`, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(pushSubscription)
                // });

            } catch (error) {
                console.error('Erro ao ativar notificações do sistema:', error);
                alert(`Erro ao ativar notificações do sistema: ${error.message}. Verifique o console.`);
            }
        }

        // Função utilitária para converter Base64 URL para Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // --- Lógica de Geração e Envio de Notificações ---

        // Função para enviar uma notificação push via backend
        async function sendPushNotificationToSystem(platform, commission, customText) {
            if (!pushSubscription) {
                alert('Por favor, ative as notificações do sistema primeiro (clique no botão verde).');
                console.warn('Não há inscrição push ativa. Notificação do sistema não enviada.');
                return;
            }

            // Validação básica do valor da comissão
            if (isNaN(commission) || commission === null) {
                commission = 0; // Define como 0 se for inválido
                console.warn('Valor de comissão inválido. Usando 0.');
            }

            // Formatação do valor da comissão para BRL
            const formattedCommission = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(commission);

            // Monta a mensagem e dados para enviar ao backend
            let title = platform.name;
            let body = `Venda aprovada: Sua comissão ${formattedCommission}`;
            if (customText) {
                body = `Venda aprovada: ${customText} - ${formattedCommission}`;
            }

            const notificationPayload = {
                title: title,
                body: body,
                icon: platform.logo, // Ícone da plataforma na notificação do sistema
                data: {
                    url: window.location.origin // O que acontece ao clicar na notificação
                }
            };

            try {
                // Envia a solicitação para o seu backend
                const response = await fetch(BACKEND_PUSH_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subscription: pushSubscription, // Envia a inscrição para o backend
                        payload: notificationPayload
                    })
                });

                if (response.ok) {
                    console.log('Solicitação de notificação push enviada ao backend com sucesso!');
                    // A notificação real aparecerá na barra de notificações do sistema, não aqui.
                } else {
                    const errorData = await response.json();
                    console.error('Falha ao enviar notificação push ao backend:', response.status, errorData);
                    alert(`Falha ao enviar notificação push: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Erro de rede ao enviar notificação push:', error);
                alert(`Erro de rede ao enviar notificação: ${error.message}. Verifique a conexão e o endpoint do backend.`);
            }
        }

        // Função para iniciar a sequência de notificações push
        function startNotificationSequence() {
            // Esconde o botão Gerar e mostra o botão Parar
            generateBtn.style.display = 'none';
            stopBtn.style.display = 'block';

            // Para qualquer sequência existente antes de iniciar uma nova
            stopNotificationSequence();

            const selectedPlatformId = platformSelect.value;
            const platform = platformData[selectedPlatformId];
            
            let commissionValue = parseFloat(commissionInput.value);
            if (isNaN(commissionValue) || commissionInput.value.trim() === '') {
                commissionValue = 0;
            }

            const customText = customTextInput.value.trim();
            const quantity = parseInt(quantityInput.value, 10);
            const interval = parseFloat(intervalInput.value) * 1000;

            if (isNaN(quantity) || quantity < 1) {
                alert('Por favor, insira uma quantidade válida de notificações (mínimo 1).');
                return;
            }
            if (isNaN(interval) || interval < 500) {
                alert('Por favor, insira um intervalo válido (mínimo 0.5 segundos).');
                return;
            }

            if (!pushSubscription) {
                alert('Por favor, ative as notificações do sistema primeiro (clique no botão verde) antes de gerar a sequência.');
                stopNotificationSequence(); // Garante que botões voltem ao normal
                return;
            }

            currentNotificationCount = 0;

            // Inicia o intervalo para disparar as notificações push
            notificationSequenceInterval = setInterval(() => {
                if (currentNotificationCount < quantity) {
                    sendPushNotificationToSystem(platform, commissionValue, customText);
                    currentNotificationCount++;
                } else {
                    stopNotificationSequence();
                }
            }, interval);
        }

        // Função para parar a sequência de notificações
        function stopNotificationSequence() {
            if (notificationSequenceInterval) {
                clearInterval(notificationSequenceInterval);
            }
            // Mostra o botão Gerar e esconde o botão Parar
            generateBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            currentNotificationCount = 0;
        }

        // Event Listeners
        activateSystemNotificationsBtn.addEventListener('click', requestNotificationPermissionAndSubscribe);
        generateBtn.addEventListener('click', startNotificationSequence);
        stopBtn.addEventListener('click', stopNotificationSequence);

        // Previne o comportamento padrão do Enter em campos de input
        const inputElements = [commissionInput, customTextInput, quantityInput, intervalInput];
        inputElements.forEach(input => {
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    startNotificationSequence();
                }
            });
        });

        // Opcional: Verifique o status da permissão e da inscrição ao carregar a página
        async function checkSubscriptionStatus() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    pushSubscription = await registration.pushManager.getSubscription();
                    if (pushSubscription) {
                        console.log('Inscrição Push ativa ao carregar a página.');
                    } else {
                        console.log('Nenhuma inscrição Push ativa ao carregar a página.');
                    }
                }
            }
        }
        checkSubscriptionStatus();
    </script>
</body>
</html>
